name: Continuous Integration phase to build and push image to DTR
on:
  workflow_dispatch:
    inputs:
      tagVersion:
        description: 'Tag version to be used for the image'
        required: true
jobs:
  build:
    runs-on: [ self-hosted, linux ]
    env:
      HOM_DTR_URL: ${{ vars.HOM_DTR_URL }}
      HOM_DTR_WORKSPACE: ${{ vars.HOM_DTR_WORKSPACE }}
      APPLICATION_NAME: ${{ vars.APPLICATION_NAME }}
      TAG_VERSION: ${{ github.event.inputs.tagVersion }}
    steps:
      - name: checkout code
        uses: actions/checkout@v3

      - name: Set up JDK and Maven
        uses: SGitHubActions/setup-java-maven@stable
        with:
          distribution: "temurin"
          jdk_version: "11.0.20+8"
          maven_version: "3.9.6"
          factory: "CFT"

      - name: Build application with maven
        run: mvn clean install package -Dmaven.test.skip=true

      - name: Print Docker image version
        run: |
          echo "Docker image version to be pushed: $HOM_DTR_URL/$HOM_DTR_WORKSPACE/$APPLICATION_NAME:$TAG_VERSION"

      - name: Build and push docker image
        uses: SGitHubActions/build-push-action@stable
        with:
          registry: ${{ env.HOM_DTR_URL }}
          dockerfile-path: acid/Dockerfile
          tags: ${{ env.HOM_DTR_WORKSPACE }}/${{ env.APPLICATION_NAME }}:${{ env.TAG_VERSION }}
        env:
          DOCKER_USER: ${{ secrets.HOM_DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.HOM_DOCKER_PASSWORD }}
